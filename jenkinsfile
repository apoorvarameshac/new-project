pipeline {
    agent any
    
    environment {
        IMG_NAME = 'apoorvar12/python-app'
        TAG_NAME = "v1.0.${BUILD_NUMBER}"
        FULL_IMAGE = "${IMG_NAME}:${TAG_NAME}" 
    }

    stages {
        stage('Clone') {
            steps {
                echo 'Cloning the git repository'
                git branch: 'main', url: 'https://github.com/apoorvarameshac/new-project.git'
            }
        }
        stage('Build') {
            steps {
                
                   sh 'docker build -f docker/Mydockerfile -t ${FULL_IMAGE} .'
                    
            }
        }
        
        stage('Push') {
            steps {
                echo 'Pushing the image to dockerHub'
                withCredentials([usernamePassword(credentialsId: 'dockerhub', passwordVariable: 'password', usernameVariable: 'username')]) {
                    
                sh '''
                
                    echo "$password" | docker login -u "$username" --password-stdin
                    echo "Login Succesful" 
                    docker push $FULL_IMAGE
                    
                
                '''
                }
              } 
            }
            stage('Manifest files update') {
            steps {
                
                echo 'Updating the manifest files'
                withCredentials([usernamePassword(credentialsId: 'github', passwordVariable: 'gitpass', usernameVariable: 'gituser')]) {
                sh '''
                echo "Updating deployment yaml files with new image:${FULL_IMAGE}"
                sed -i "s|image:.*|image: ${FULL_IMAGE}|" manifests/deployment.yaml
                
                        git config --global user.email "devops@automation.com"
                        git config --global user.name "Jenkins Automation"

                        git add manifests/deployment.yaml
                        git diff-index --quiet HEAD || git commit -m "Update image to ${FULL_IMAGE} "

                        # Push back to updates branch
                        git push https://${gituser}:${gitpass}@github.com/apoorvarameshac/new-project.git --force
                '''
                }
            }
        }
        
    }
}
